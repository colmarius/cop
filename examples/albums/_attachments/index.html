<!DOCTYPE html>
<html>
  <head>
    <title>My Albums</title>
    <link rel="stylesheet" href="style/jquery.mobile-1.0a3.css" type="text/css">
    <link rel="stylesheet" href="style/main.css" type="text/css">
  </head>
  <body>
  
    <div id="home" data-role="page">
      <div data-role="header" data-position="fixed">
        <h1>Albums</h1>
      </div>
      <div data-role="content">
        <ul id="albums" data-role="listview" data-theme="c" data-dividertheme="b" />
      </div>
      <div data-role="footer" data-position="fixed">
        <div data-role="navbar">
          <ul class="ui-grid-b">
            <li style="width:30%;"><a href="#addAlbum" data-transition="slideup" data-icon="plus">Add Album</a></li>
            <li style="width:45%;"><a href="#manageContexts" data-transition="slideup" data-icon="grid">Manage Contexts</a></li>
            <li style="width:25%;"><a href="#logInfo" data-transition="slideup" data-icon="info">Log</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    <div id="manageContexts" data-role="page">
      <div data-role="header"><h1>Manage Contexts</h1></div>
      <div data-role="content" data-theme="c" style="padding:0em;">
        <form id="manageContextsForm" action="#" method="get"> 
          <div data-role="fieldcontain">
            <fieldset data-role="controlgroup">
              <legend>Choose to:</legend>
              <input id="securityContext" name="Security" type="checkbox" class="custom" />
              <label for="securityContext">Revoke privileges</label>
              <input id="lowBatteryContext" name="LowBattery" type="checkbox" class="custom" />
              <label for="lowBatteryContext">Remove transitions</label>
              <input id="loggingContext" name="Logging" type="checkbox" class="custom" />
              <label for="loggingContext">Do logging</label>
            </fieldset>
          </div>
        </form>
      </div>
      <!-- I had to take out the footer so the next "page" would not be aded to this div[data-role="page"] -->
    </div>
    
    <div id="addAlbum" data-role="page">
      <div data-role="header"><h1>Add Album</h1></div>
      <div data-role="content" data-theme="c" style="padding:0em;">
        <form id="albumAddForm" action="#" method="get">
          <div data-role="fieldcontain">
            <label for="artist">Artist:</label>
            <input id="addArtistField" name="artist" type="text" />
          </div>
          <div data-role="fieldcontain">
            <label for="title">Title:</label>
            <input id="addTitleField" name="title" type="text" />
          </div>
          <div data-role="fieldcontain">
            <label for="description">Description:</label>
            <textarea id="addDescriptionField" name="description" cols="40" rows="8"></textarea>
          </div>
          <div class="ui-body ui-body-b">
            <fieldset class="ui-grid-a">
              <div class="ui-block-a">
                <a href="#home" id="addCancelButton" data-role="button" data-theme="d">Cancel</a>
              </div>
              <div class="ui-block-b">
                <a href="#" id="addSubmitButton" data-role="button" data-theme="a">Submit</a>
              </div>
            </fieldset>
          </div>
        </form>
      </div>
      <!-- I had to take out the footer so the next "page" would not be aded to this div[data-role="page"] -->
    </div>
    
    <div id="logInfo" data-role="page">
      <div data-role="header">
        <h1>Log info</h1>
      </div>
      <div data-role="content" data-theme="c" style="padding:0em;">
        <p>Log messages go here:</p>
        <div id="log"></div>
      </div>
    </div>
    
    <div id="lastDiv" />
    
  </body>
  <script src="vendor/couchapp/loader.js"></script>
  <script type="text/javascript" charset="utf-8">
   
    $db = $.couch.db( "albums" );
    
    function handleDocumentReady()
    {
      $("#home").bind( "pagebeforeshow", function( ) {
        refreshAlbums();  
      });
            
      refreshAlbums();
      
      $("#addSubmitButton").live( "click", function( event ) {
        event.preventDefault();
        var document = {};
        document.artist = $("input#addArtistField").val();
        document.title  = $("input#addTitleField").val();
        document.description = $("textarea#addDescriptionField").val();
        document.creation_date = ( new Date() ).getTime();
        // Create a new document.
        $db.saveDoc( document, {
            success: function() {
              $.mobile.changePage( "#home", "slidedown", true, true );
            }
            ,error: function() {
              alert( "Cannot save document." );
            }
        });
        return false;
      });
      
      $("#addAlbum").bind( "pagehide", function() {
        $("input#addArtistField").val( "" );
        $("input#addTitleField").val( "" );
        $("textarea#addDescriptionField").val( "" );
      });
      
      $("#manageContexts").bind( "pagehide", function() {
        var contextIds = ["securityContext", "loggingContext", "lowBatteryContext"];
        
        for( var i in contextIds )
        {
          var ctxId = "#" + contextIds[i];
          var contextName = $(ctxId).attr("name");
          var contextState = $(ctxId).attr("checked")
          var context = copContextRegistry.retrieve( contextName );
          
//          console.log( "Context " + contextName + " now is " + contextState );
          
          if( contextState === true ) {
            context.activate();
          } else {
            context.deactivate();
          }
        }
      });
      
      loadContexts();
    }
    
    function refreshAlbums()
    {
      $("#albums").empty();
      
      $db.view("albums/albums",
                { 
                  success: function( data ) 
                  { 
                    var  i
                        ,album
                        ,artist
                        ,title
                        ,description
                        ,listItem;
                    data.rows.reverse();
                    for( i in data.rows )
                    {
                      album = data.rows[i].value;
                      artist = album.artist;
                      title = album.title;
                      description = album.description;
                      externalPage = $.mobile.path.origin + "_show/album/" + album._id;
                      //externalPage = "_show/album/" + album._id;
                      listItem = "<li class=\"album\">" +
                                    "<a href=\"" + externalPage + "\">" +
                                      "<h2 class=\"artist\">" + artist + "<\/h2>" +
                                    "<\/a>" +
                                    "<p class=\"title\">" + title + "<\/p>" +
                                    "<p class=\"description\">" + description + "<\/p>" +
                                  "<\/li>";
                      $('#albums').append( listItem );
                    }
                    $('#albums').listview( "refresh" );
                    $.fixedToolbars.show();
                  }
        });
    }
    
    function loadContexts()
    {
      var Logging, Security, LowBattery, blacklist, blacklistMessages;
      
      Logging = new copContext( "Logging" );
      
      Logging.adapt( console, Trait({
          log: function(var_args) {
            var strings = [], i;
            for( i = 0, len = arguments.length; i < len; i += 1)
            {
              strings.push( arguments[i] );
            }
            $("#log").append( "<p>" + strings.join(" ") + "</p>" );
          }
      }));
      
      Logging.adapt( $.mobile, Trait({
          changePage: function(to, transition, back, changeHash) {
            console.log( "Going to page: " + to );
            this.original.changePage(to, transition, back, changeHash);
          }
      }));
      
      blacklist = [ "album-delete","album-edit" ];
      blacklistMessages = [ "album delete page","album edit page" ];
      
      Security = new copContext( "Security" );
      
      Security.adapt( $.mobile, Trait({
          changePage: function(to, transition, back, changeHash) {
            for( var i in blacklist )
            {
              var onBlacklist = blacklist[i];
              // console.log( onBlacklist );
              if( (typeof to === "string") && (to.indexOf(onBlacklist) >=0) ) 
              {
                console.log( "Access denied to " + to );
                alert( "You do not have access to " + blacklistMessages[i] );
                return;
              }  
            }
            console.log( "Acces granted to: " + to );
            this.original.changePage( to, transition, back, changeHash );
          }
      }));
      
      LowBattery = new copContext( "LowBattery" );
      
      LowBattery.adapt( $.mobile, Trait({
          changePage: function(to, transition, back, changeHash) {
            console.log( "Transition: " + transition + ", to page: " + to + ", is ignored." );
            this.original.changePage( to, "none", back, changeHash );
          }
      }));
    }
    
    $(document).ready( handleDocumentReady );
    
  </script>
</html>
