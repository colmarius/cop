<!doctype html>
<html>
  <head>
    <title>Contexts Demo</title>
    <link rel="stylesheet" href="vendor/codemirror.css">
    <link rel="stylesheet" href="vendor/simple-hint.css">
    <link rel="stylesheet" href="vendor/docs.css">
    <script src="vendor/codemirror.js"></script>
    <script src="vendor/simple-hint.js"></script>
    <script src="vendor/javascript-hint.js"></script>
    <script src="vendor/searchcursor.js"></script>
    <script src="vendor/match-highlighter.js"></script>
    <script src="vendor/javascript.js"></script>
    <script src="../../test/vendor/underscore-1.3.1.js"></script>
    <script src="../../test/vendor/backbone-0.9.1.js"></script>
    <script src="../../test/vendor/traits-0.4.js"></script>
    <script src="../../cop.js"></script>
    <style type="text/css">
      body {
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .CodeMirror { 
        border: 1px solid #eee;
      }
      .CodeMirror-scroll {
        height: 400px;
        overflow: auto;
        width: 100%;
      }
      span.CodeMirror-matchhighlight { 
        background: #e9e9e9 
      }
      .CodeMirror-focused span.CodeMirror-matchhighlight { 
        background: #e7e4ff; !important 
      }
    </style>
  </head>
  <body>
    <h1>Code and Play: Contexts demo</h1>
    <textarea id="code" name="code">
var batteryLevel = 100;
var connectedToInternet = true;
var gpsAvailable = true;

var MYAPP = {
  initScreen: function() {
    print("MYAPP initialized normally.");
  }
};

var batteryLow = new Cop.Context({
  name: 'batteryLow',
  initialize: function() {
    if (batteryLevel <= 30) this.activate();
  }
});

var offline = new Cop.Context({
  name: 'offline',
  initialize: function() {
    if (connectedToInternet == false) this.activate();
  }
});

var noGPS = new Cop.Context({
  name: 'noGPS',
  initialize: function() {
    if (gpsAvailable === false) this.activate();
  }
});

var cm = new Cop.ContextManager({
  contexts: [batteryLow, offline, noGPS],
  relations: {}
});

batteryLow.adapt(MYAPP, Trait({
  initScreen: function() {
    //this._super.initScreen();
    print("MYAPP running with low battery.")
  }
}));

offline.adapt(MYAPP, Trait({
  initScreen: function() {
    print("MYAPP running with no internet connection.");
  }
}));

noGPS.adapt(MYAPP, Trait({
  initScreen: function() {
    print("MYAPP running with no GPS.");
  }
}));

cm.resolveConflict(MYAPP, [offline, batteryLow], function(offlineT, batteryLowT) {
  return Trait.compose(
    Trait.resolve({initScreen: 'initScreenBatteryLow'}, batteryLowT), 
    Trait.resolve({initScreen: 'initScreenOffline'}, offlineT),
    Trait({
      initScreen: function() {
        print("MYAPP running 'offline' with 'battery low'.");
        this.initScreenOffline();
        this.initScreenBatteryLow();
      }
    })
  );
});

cm.resolveConflict(MYAPP, [offline, noGPS, batteryLow], function(offlineT, noGPST, batteryLowT) {
  return Trait.compose(
    Trait.resolve({initScreen: 'initScreenNoGPS'}, noGPST), 
    Trait.resolve({initScreen: 'initScreenOffline'}, offlineT),
    Trait.resolve({initScreen: 'initScreenBatteryLow'}, batteryLowT), 
    Trait({
      initScreen: function() {
        print("MYAPP running 'offline', with 'battery low', and 'no GPS'.");
        this.initScreenBatteryLow();
        this.initScreenNoGPS();
        this.initScreenOffline();
      }
    })
  );
});

cm.start(); // now contexts are initialized and objects are composed accordingly

MYAPP.initScreen();
    </textarea></br>
    <button onclick="doRun();">Run!</button>
    <pre id="output" class="cm-s-default"></pre>

    <p>
      <i>Some hints</i>: press <strong>ctrl-space</strong> to activate autocompletion; 
      double-click on select to <strong>highlight</strong> matches of selected text.
    </p>

    <script>
      var messages = [];
      function print(line) { messages.push(line); };
      function doRun() {
        messages = [];
        eval(editor.getValue());
        document.getElementById("output").innerHTML = messages.join("\n");
      }
      CodeMirror.commands.autocomplete = function(cm) {
        CodeMirror.simpleHint(cm, CodeMirror.javascriptHint);
      }
      var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
        lineNumbers: true,
        tabSize: 2,
        extraKeys: {"Ctrl-Space": "autocomplete"},
        onCursorActivity: function() {
          editor.matchHighlight("CodeMirror-matchhighlight");
        }
      });
    </script>
  </body>
</html>
